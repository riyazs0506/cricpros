{% extends "base.html" %}
{% block content %}

<div class="chat-container">
    <div class="chat-header">
        ðŸ’¬ Chat with <strong>{{ other_user.username }}</strong>
    </div>

    <div class="chat-body" id="chatBody">
        {% for m in messages %}
        <div class="msg {{ 'sent' if m.sender_id == current_user.id else 'recv' }}">
            {{ m.content }}

            {% if m.sender_id == current_user.id %}
            <span class="tick">
                {% if m.is_read %}
                    âœ”âœ”
                {% elif m.delivered %}
                    âœ”
                {% endif %}
            </span>

            <form method="post" action="{{ url_for('delete_message', msg_id=m.id) }}" style="display:inline">
                <button class="btn btn-sm btn-danger">ðŸ—‘</button>
            </form>
            {% endif %}
        </div>
        {% endfor %}
    </div>

    <form id="sendForm">
        <input id="msgInput" class="form-control" placeholder="Type message..." required>
        <button class="btn btn-primary mt-2">Send</button>
    </form>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
const socket = io();
const chatBody = document.getElementById("chatBody");

document.getElementById("sendForm").onsubmit = e => {
    e.preventDefault();

    const msg = msgInput.value;
    socket.emit("send_message", {
        sender_id: {{ current_user.id }},
        receiver_id: {{ other_user.id }},
        content: msg
    });

    msgInput.value = "";
};

socket.on("receive_message", data => {
    if (
        data.sender_id == {{ other_user.id }} ||
        data.sender_id == {{ current_user.id }}
    ) {
        const div = document.createElement("div");
        div.className = "msg recv";
        div.innerHTML = data.content;
        chatBody.appendChild(div);
        chatBody.scrollTop = chatBody.scrollHeight;
    }
});
</script>

{% endblock %}
