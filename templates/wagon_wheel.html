{% extends "base.html" %}
{% block title %}Shot Animation — {{ player.user.username }}{% endblock %}

{% block content %}

<h3 class="fw-bold">{{ player.user.username }} — Shot Animation (Side View)</h3>
<p class="text-muted">Match: {{ match.title }}</p>

<style>
#stadium {
   width: 100%;
   height: 320px;
   background: linear-gradient(to top, #2b8e2b 0%, #56bb56 30%, #93d893 100%);
   border-radius: 10px;
   position: relative;
   overflow: hidden;
   border: 4px solid #0a620a;
}

/* Pitch on left */
#pitch {
   position: absolute;
   bottom: 65px;
   left: 70px;
   width: 90px;
   height: 5px;
   background: #d4c29a;
}

/* Ball */
#ball {
   width: 14px;
   height: 14px;
   background: red;
   border-radius: 50%;
   position: absolute;
   left: 80px;
   bottom: 75px;
   display: none;
}

/* Shadow */
#shadow {
   width: 20px;
   height: 6px;
   background: rgba(0,0,0,0.2);
   border-radius: 50%;
   position: absolute;
   left: 80px;
   bottom: 65px;
   display: none;
}

/* Landing dust */
.dust {
   width: 10px;
   height: 10px;
   background: rgba(255,255,255,0.7);
   border-radius: 50%;
   position: absolute;
   animation: dust 0.5s ease-out;
}
@keyframes dust {
   0% { transform: scale(0.3); opacity: 1; }
   100% { transform: scale(1.5); opacity: 0; }
}
</style>

<div id="stadium">
    <div id="pitch"></div>
    <div id="ball"></div>
    <div id="shadow"></div>
</div>

<div class="card p-3 shadow-sm w-50 mt-3">
    <label class="fw-bold">Shot Type</label>
    <select id="shot_type" class="form-select mb-3">
        <option>Drive</option>
        <option>Pull</option>
        <option>Cut</option>
        <option>Flick</option>
        <option>Uppercut</option>
        <option>Lofted</option>
    </select>

    <label class="fw-bold">Runs</label>
    <select id="runs" class="form-select mb-3">
        <option value="4">4</option>
        <option value="6">6</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
    </select>

    <button class="btn btn-success" onclick="playShot()">Play Shot Animation</button>
</div>

<script>
// BALL START POSITION
const ball = document.getElementById("ball");
const shadow = document.getElementById("shadow");

function playShot() {
    ball.style.display = "block";
    shadow.style.display = "block";

    let t = 0;
    const duration = 1.8; // seconds
    const fps = 60;

    // Random distance based on runs
    const runs = parseInt(document.getElementById("runs").value);
    let distance = runs === 6 ? 620 : runs === 4 ? 450 : 300;

    // Arc height based on shot
    const shotType = document.getElementById("shot_type").value;
    let height = shotType === "Lofted" || shotType === "Uppercut" ? 180 : 110;

    const startX = 80; 
    const startY = 75;

    const endX = startX + distance;
    const endY = 70; // ground level

    function frame() {
        t += 1 / fps;

        let progress = t / duration;
        if (progress > 1) progress = 1;

        // Horizontal movement
        const x = startX + (endX - startX) * progress;

        // Vertical parabolic flight
        const y = startY + (height * Math.sin(Math.PI * progress));

        // Shadow movement
        const shadowX = x;
        const shadowY = 65;

        ball.style.left = x + "px";
        ball.style.bottom = y + "px";

        shadow.style.left = shadowX + "px";
        shadow.style.bottom = shadowY + "px";

        if (progress < 1) {
            requestAnimationFrame(frame);
        } else {
            landEffect(endX, endY);
            saveShot(distance, runs, shotType);
        }
    }

    frame();
}

// Dust effect on landing
function landEffect(x, y) {
    const d = document.createElement("div");
    d.className = "dust";
    d.style.left = x + "px";
    d.style.bottom = "75px";
    document.getElementById("stadium").appendChild(d);

    setTimeout(() => d.remove(), 600);
}

// Save to backend
function saveShot(distance, runs, shotType) {
    fetch(`/api/wagon/{{ match.id }}/{{ player.id }}/add`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            angle: 0,              // (side view doesn't use angle)
            distance: distance,
            runs: runs,
            shot_type: shotType
        })
    });
}
</script>

{% endblock %}
