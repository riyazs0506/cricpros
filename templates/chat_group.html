{% extends "base.html" %}
{% block content %}

<div class="chat-container">
    <div class="chat-header">
        ğŸ‘¥ {{ group.name }}
    </div>

    <div class="chat-body" id="chatBody">
        {% for m in messages %}
            <div class="msg {{ 'sent' if m.sender_id == current_user.id else 'recv' }}"
                 id="msg-{{ m.id }}">
                
                <strong>{{ users_map[m.sender_id].username }}</strong><br>
                <span class="msg-text">{{ m.content }}</span>

                {% if m.sender_id == current_user.id %}
                    <div class="msg-actions">
                        <a href="#" onclick="editMsg({{ m.id }}, '{{ m.content }}')">âœï¸</a>
                        <a href="#" onclick="deleteMsg({{ m.id }})">ğŸ—‘</a>
                    </div>
                {% endif %}
            </div>
        {% endfor %}
    </div>

    <div class="chat-footer">
        <input id="groupMessage" class="form-control" placeholder="Type message...">
        <button class="btn btn-primary mt-2" onclick="sendGroupMessage()">Send</button>
    </div>
</div>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
const socket = io();
socket.emit("join_group", { group_id: {{ group_id }} });

// SEND
function sendGroupMessage() {
    const input = document.getElementById("groupMessage");
    if (!input.value.trim()) return;

    socket.emit("send_group_message", {
        group_id: {{ group_id }},
        content: input.value
    });

    input.value = "";
}

// RECEIVE
socket.on("receive_group_message", data => {
    if (data.group_id !== {{ group_id }}) return;

    const div = document.createElement("div");
    div.className = "msg " + (data.sender_id === {{ current_user.id }} ? "sent" : "recv");
    div.id = "msg-" + data.id;

    div.innerHTML = `
        <strong>${data.sender_name}</strong><br>
        <span class="msg-text">${data.content}</span>
        ${data.sender_id === {{ current_user.id }} ? `
        <div class="msg-actions">
            <a href="#" onclick="editMsg(${data.id}, '${data.content}')">âœï¸</a>
            <a href="#" onclick="deleteMsg(${data.id})">ğŸ—‘</a>
        </div>` : ""}
    `;

    document.getElementById("chatBody").appendChild(div);
});

// EDIT
function editMsg(id, oldText) {
    const newText = prompt("Edit message", oldText);
    if (!newText) return;

    socket.emit("edit_group_message", {
        msg_id: id,
        content: newText
    });
}

socket.on("group_message_edited", data => {
    if (data.group_id !== {{ group_id }}) return;
    document.querySelector(`#msg-${data.msg_id} .msg-text`).innerText = data.content;
});

// DELETE
function deleteMsg(id) {
    if (!confirm("Delete message?")) return;
    socket.emit("delete_group_message", { msg_id: id });
}

socket.on("group_message_deleted", data => {
    if (data.group_id !== {{ group_id }}) return;
    document.getElementById("msg-" + data.msg_id).remove();
});
</script>

{% endblock %}